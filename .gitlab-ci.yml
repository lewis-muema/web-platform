image: node:12.22.0

stages:
  - test
  - lint
  - build
  - deploy

variables:
  STAGING_DOCKER_IMAGE: '${CI_REGISTRY}/vue-webplatform:latest_${CI_COMMIT_SHORT_SHA}'
  STAGING_DOCKER_IMAGE_LATEST: '${CI_REGISTRY}/vue-webplatform:latest'

# Lets name our Job eslint, because that's what it's doing.
eslint:
  # tell eslint what stage it is. (This could also be build or test for example)
  stage: lint
  tags:
    - docker

  # What scripts do we want to run?
  script:
    # install eslint
    - npm i eslint
    # Run eslint
    - npm run lint

# Lets name our Job unitTest, because that's what it's doing.
unitTest:
  # tell eslint what stage it is. (This could also be build or test for example)
  stage: test
  tags:
    - docker

  # What scripts do we want to run?
  script:
    # install mocha-webpack
    - npm i mocha-webpack
    # Run tests
    - npm run test

build:staging:
  stage: build
  tags:
    - shell
  before_script:
    - echo "$STAGING_DOCKER_IMAGE"
  script:
    - docker build --build-arg DOCKER_ENV="testing" -t "$STAGING_DOCKER_IMAGE"  -t "$STAGING_DOCKER_IMAGE_LATEST" .
    - docker push "$STAGING_DOCKER_IMAGE"
    - docker push "$STAGING_DOCKER_IMAGE_LATEST"
  only:
    - master

deploy:staging:
  stage: deploy
  tags:
    - shell
  script:
    - ssh -i ~/keys/id_rsa -f -o StrictHostKeyChecking=no -l admin kubetest-master.sendyit.com "kubectl set image deploy vue-web-platform vue-web-platform=${STAGING_DOCKER_IMAGE}"
  only:
    - master

build:prod:
  stage: build
  tags:
    - shell
  before_script:
    - export PROD_DOCKER_IMAGE="${CI_REGISTRY}/vue_web_platform:prod_$(date +%Y-%m-%d-%H-%M)"
    - export PROD_DOCKER_IMAGE="${CI_REGISTRY}/vue_web_platform:prod"
    - echo "$PROD_DOCKER_IMAGE"
  script:
    - docker build --build-arg DOCKER_ENV="production" -t "$PROD_DOCKER_IMAGE" .
    - docker push "$PROD_DOCKER_IMAGE"
  only:
    - production

build:preview_env:
  stage: build
  tags:
    - shell
  before_script:
    - export PREVIEW_ENV_IMAGE_NAME="sendy-docker-local.jfrog.io/vue-webplatform:$(echo $CI_COMMIT_REF_NAME | awk -F "/" '{ print $2 }')_$(date +%Y-%m-%d-%H-%M)"
    - export FEATURE_ENV="$(echo $CI_COMMIT_REF_NAME | awk -F "/" '{ print $2 }')"
    - echo "$FEATURE_ENV"
  script:
    - docker build -t "${PREVIEW_ENV_IMAGE_NAME}" .
    - docker push "$PREVIEW_ENV_IMAGE_NAME"
  only:
    refs:
      - /^feature*.*$/

create-preview-env:
  stage: deploy
  tags:
    - manta
  before_script:
    - export FEATURE="$(echo $CI_COMMIT_REF_NAME | awk -F "/" '{ print $2 }')"
  script:
    - pwd
    - source ~/.bash_profile && /opt/manta -c $FEATURE -f /home/ubuntu/.kube/config
  only:
    refs:
      - /^feature*.*$/
